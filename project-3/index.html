<!doctype html>
<html>
<head>
  <title>Ping! Pong!</title>
</head>
<style>
  .container { padding: 2em; }
  .center.aligned { text-align: center; }
  canvas {
    display: block;
    background: #59ABE3;
    margin: 0 auto;
  }
</style>
<body>
  <div class="center aligned container">
    <h1 class="header">Ping! Pong!</h1>
    <canvas id="pingpong" width="650" height="480"></canvas>
  </div>
</body>
<script>
function Game(canvasId){
  this.game = this;
  this.id = canvasId;
  this.canvas = document.getElementById(this.id);
  this.context = this.canvas.getContext('2d');
  
  this.width = 0;
  this.height = 0;
  
  function Ball(boundWidth, boundHeight){
    this.x = 0; this.y = 0;
    this.dx = 5; this.dy = 5;
    this.rad = 10;
    this.color = "#fff";
    
    this.set = function(newX, newY){
      this.x = newX;
      this.y = newY;
    };
    
    this.setD = function(_dx, _dy){
      this.dx = _dx;
      this.dy = _dy;
    };
    
    this.update = function(){
      var nextX = this.x + this.dx;
      var nextY = this.y + this.dy;
      if(nextX < this.rad || nextX > boundWidth - this.rad){
        this.dx *= -1;
      }
      if(nextY < this.rad || nextY > boundHeight - this.rad){
        this.dy *= -1;
      }
      this.x += this.dx;
      this.y += this.dy;
    };
    
    this.draw = function(context){
      context.beginPath();
      context.fillStyle = this.color;
      context.arc(this.x, this.y, this.rad, 0, Math.PI * 2, true);
      context.closePath();
      context.fill();
    };
  }
  
  function Racket(x, size, color, boundHeight){
    this.x = x;
    this.y = boundHeight / 2;
    this.dy = 0;
    this.direction = 0;
    this.draw = function(context){
      context.fillStyle = color;
      context.fillRect(this.x, this.y - size/2, 10, size);
    };
    this.accelate = function(dy){
      this.dy += dy;
    };
    this.call = 0;
    this.update = function(){
      // going to zero
      if(++this.call % 10 == 0){
        // per 10 times becuase be slowing is too fast
        this.dy *= 0.9;
        this.call = 0;
      }
      if(Math.abs(this.dy) < 1e-10) this.dy = 0;
      
      this.y = this.y + (this.dy / 10);
      if(this.y - size/2 < 0 || this.y + size/2 > boundHeight){
        this.y = Math.max(this.y, size/2);
        this.y = Math.min(this.y, boundHeight - size/2);
        this.dy = 0;
      }
    };
  }
  
  this.init = function(stageName){
    this.stage = stageName;
    this.balls = [];
    this.racket1 = this.racket2 = null;
  };
  
  this.state = function(stageName){
    var width = this.context.canvas.width;
    var height = this.context.canvas.height;
    this.init(stageName);
    if(stageName == 'INTRO'){
    } else if(stageName == 'PLAY_DUO'){
      this.racket1 = new Racket(1*width/10, height/5, '#fff', height);
      this.racket2 = new Racket(9*width/10, height/5, '#fff', height);
      this.pushBall(1, '#fff');
    }
  };
  
  this.draw = function(context){
    var width = context.canvas.width;
    var height = context.canvas.height;
    context.clearRect(0, 0, width, height);
    
    for(var i in this.balls){
      this.balls[i].draw(context);
    }

    context.font = "40px Arial";
    context.fillStyle = "#ffffff";
    context.textAlign = "center";
    if( this.stage == 'INTRO'){
      context.fillText("PING PONG", width/2, height/3);
      context.fillText("press SPACE to start", width/2, 2*height/3);
    } else if( this.stage == 'GAME_OVER' ){ 
      context.fillText("GAME OVER", width/2, height/3);
      context.fillText("press SPACE to start", width/2, 2*height/3);
    } else if( this.stage == 'PLAY_DUO' ){
      this.racket1.draw(context);
      this.racket2.draw(context);
    }
  };
  
  this.keypress_table = {};
  this.fireKeydown = function(event){
    var _this = game;
    _this.keypress_table[event.code.toString()] = true;
    
    if(_this.stage == 'INTRO' || _this.stage == 'GAME_OVER'){
      switch(event.code){
      case 'Space':
        _this.state('PLAY_DUO');
      }
    }
  }
  this.fireKeyup = function(event){
    game.keypress_table[event.code.toString()] = false;
  }
  
  this.callCount = 0;
  this.update = function(){
    if(this.stage == 'PLAY_DUO'){
      if(this.keypress_table['KeyA']) if(this.racket1) this.racket1.accelate(-5);
      if(this.keypress_table['KeyZ']) if(this.racket1) this.racket1.accelate(+5);
      if(this.keypress_table['KeyK']) if(this.racket2) this.racket2.accelate(-5);
      if(this.keypress_table['KeyM']) if(this.racket2) this.racket2.accelate(+5);
    }
    
    for(var i in this.balls){
      this.balls[i].update();
    }
    
    if(this.racket1) this.racket1.update();
    if(this.racket2) this.racket2.update();
  }
  
  this.tick = function(){
    this.update();
    this.draw(this.context);
  };
  
  ////////// Timer functions & attributes ///////////
  this.timer = 0;
  this.start = function(){
    this.init('INTRO');
    
    for(var i=0; i<3; ++i){
      this.pushBall(Math.floor(Math.random()*5), '#' + Math.random().toString(16).substr(2, 6));
    }
    
    document.addEventListener('keydown', game.fireKeydown);
    document.addEventListener('keyup', game.fireKeyup);
    
    this.timer = setInterval(function(){
      game.tick();
    }, 10);
  };
  
  this.stop = function(){
    clearInterval(this.timer);
  };
  
  this.pushBall = function(ball_number, color){
    var width = this.context.canvas.width;
    var height = this.context.canvas.height;
    for(var i=0; i<ball_number; ++i){
      var ball = new Ball(width, height);
      ball.rad = 20;
      ball.color = color;
      ball.set(Math.random()*(width - ball.rad) + ball.rad, Math.random()*(height - ball.rad) + ball.rad);
      this.balls.push(ball);
    }
  };
}

var game = new Game('pingpong');
game.start();
game.pushBall(1);
</script>
</html>